##VIEWS

# 1. Total number of flights by airline and airport on a monthly basis
CREATE OR REPLACE VIEW AIR_TRAVEL.PUBLIC.V_TOTAL_AIR_LINES
AS
SELECT COUNT(FLIGHT_NUMBER)  
as TOTAL_FLIGHTS,ORIGIN_AIRPORT,AIRLINE,MONTH 
FROM   "AIR_TRAVEL"."PUBLIC"."FLIGHT" 
GROUP BY MONTH, ORIGIN_AIRPORT,AIRLINE
ORDER BY MONTH;

# 2. On time percentage of each airline for the year 2015
CREATE OR REPLACE VIEW AIR_TRAVEL.PUBLIC.V_ON_TIME_PERCENT
AS
Select Table1.AIRLINE, (NO_DELAY)*100/(TOTAL_NUMBER_OF_AIRLINE) AS ON_TIME_PERCENTAGE 
FROM(SELECT AIRLINE,COUNT(ARRIVAL_DELAY) as NO_DELAY FROM "AIR_TRAVEL"."PUBLIC"."FLIGHT" WHERE ARRIVAL_DELAY=0 AND YEAR=2015 GROUP BY AIRLINE) Table1
JOIN (SELECT AIRLINE,COUNT(AIRLINE)AS TOTAL_NUMBER_OF_AIRLINE FROM "AIR_TRAVEL"."PUBLIC"."FLIGHT" WHERE YEAR=2015 GROUP BY AIRLINE) Table2 
ON (Table1.AIRLINE= Table2.AIRLINE)

# 3. Airlines with the largest number of delay
CREATE OR REPLACE VIEW AIR_TRAVEL.PUBLIC.V_LARGEST_NUMBER_DELAY
AS
Select AIRLINE,COUNT(ARRIVAL_DELAY) AS LARGEST_NUMBER_DELAY
FROM "AIR_TRAVEL"."PUBLIC"."FLIGHT" 
WHERE ARRIVAL_DELAY > 0
GROUP BY AIRLINE
ORDER BY COUNT(ARRIVAL_DELAY) DESC;

# 4. Cancellation by Airport
CREATE OR REPLACE VIEW AIR_TRAVEL.PUBLIC.V_CANCELLATION_BY_AIRPORT
AS
SELECT ORIGIN_AIRPORT,CANCELLATION_REASON, count(CANCELLATION_REASON) as COUNT_CANCELLATION_REASON
FROM "AIR_TRAVEL"."PUBLIC"."FLIGHT"
WHERE CANCELLATION_REASON IN ('A','B','C','D')
group by CANCELLATION_REASON, ORIGIN_AIRPORT;

# 5. DELAY REASON BY AIRPORT
CREATE OR REPLACE VIEW AIR_TRAVEL.PUBLIC.V_DELAY_BY_AIRPORT
AS
SELECT  ORIGIN_AIRPORT, AIR_SYSTEM_DELAY,SECURITY_DELAY,AIRLINE_DELAY, LATE_AIRCRAFT_DELAY, WEATHER_DELAY,COUNT(ORIGIN_AIRPORT) AS TOTAL_DELAY
FROM "AIR_TRAVEL"."PUBLIC"."FLIGHT" 
WHERE AIR_SYSTEM_DELAY >0 OR SECURITY_DELAY>0 OR AIRLINE_DELAY>0 OR LATE_AIRCRAFT_DELAY>0 OR WEATHER_DELAY>0
GROUP BY  ORIGIN_AIRPORT, AIR_SYSTEM_DELAY, SECURITY_DELAY,AIRLINE_DELAY, LATE_AIRCRAFT_DELAY, WEATHER_DELAY;

# 6. AIRLINE WITH THE MOST UNIQUE ROUTES
create or replace view "AIR_TRAVEL"."PUBLIC".V_airline_wise_unique_route as
select YEAR,MONTH,DAY,AIRLINE,FLIGHT_NUMBER,ORIGIN_AIRPORT,DESTINATION_AIRPORT,
count(*) over(partition  by AIRLINE order by YEAR,MONTH,DAY,AIRLINE,FLIGHT_NUMBER,ORIGIN_AIRPORT,DESTINATION_AIRPORT) airline_wise_count
from
(
SELECT YEAR,MONTH,DAY,AIRLINE,FLIGHT_NUMBER,ORIGIN_AIRPORT,DESTINATION_AIRPORT,SCHEDULED_DEPARTURE,DEPARTURE_TIME,
  count(*) over(partition  by YEAR,MONTH,DAY,AIRLINE,FLIGHT_NUMBER order by YEAR,MONTH,DAY,AIRLINE,FLIGHT_NUMBER,DEPARTURE_TIME) unique_route,
  lead(DESTINATION_AIRPORT) over(partition  by YEAR,MONTH,DAY,AIRLINE,FLIGHT_NUMBER order by YEAR,MONTH,DAY,AIRLINE,FLIGHT_NUMBER,DEPARTURE_TIME) lead_DESTINATION_AIRPORT
FROM  "AIR_TRAVEL"."PUBLIC"."FLIGHT"
order by YEAR,MONTH,DAY,AIRLINE,FLIGHT_NUMBER,DEPARTURE_TIME asc
)
where 1=1
and  unique_route =1 and LEAD_DESTINATION_AIRPORT is null
;
